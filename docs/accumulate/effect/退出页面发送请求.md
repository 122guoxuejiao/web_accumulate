## 退出页面发送请求

### 背景：

有一个任务非常耗时会消耗后台大量算力，所以在退出页面的时候，要求前端这边发送一个请求来杀死任务。

一开始以为这个需求非常简单，就是在进入其他路由前，发送一下请求，杀死  一下任务就好了。

然而现实狠狠的打了我的脸，因为退出页面的场景不止切换路由~

### 退出页面场景：

1. 还在本网站，跳到其他路由
2. 刷新页面/关闭页面

### 还在本网站，跳到其他路由

这个比较简单，`Vue`中可以通过路由离开的钩子`beforeRouteLeave`来实现：

```js
 beforeRouteLeave(to, from, next) {
    if (任务运行中) {
        // 发送请求
    }else{
        next(true) // 用户离开
    }
 }
```

### 搜索：https://segmentfault.com/a/1190000011851736

### 刷新页面/关闭页面

然而在刷新页面的时候，`beforeRouteLeave`并不会执行，显然这不符合我们的需求。

**beforeunload**页面卸载之前:

通过面向 google 编程,找到了这个`API`,使用方法如下：

```js
// 页面卸载之前
window.onbeforeunload = e => {
  if (任务运行中) {
    // 对话框默认的提示信息根据不同的浏览器有所不同，标准的信息类似 "确定要离开此页吗？"
    return '对话框标题:在火狐等浏览器中生效'; 
  }
};
```

**对话框标题：**


**不同浏览器有差异**

return一个为true的值，下面这个弹窗就会出现


![](http://ww1.sinaimg.cn/large/005Y4rCogy1fyr8kpadj0j30bt04vglt.jpg)

### 缺陷

拦截不到，直接在地址栏跳转。

### 鼓励我一下：

觉得还不错的话，给我的项目点个[star](https://github.com/OBKoro1/Brush_algorithm)吧

[博客](http://obkoro1.com/)、[前端算法](https://github.com/OBKoro1/Brush_algorithm)、[公众号](https://user-gold-cdn.xitu.io/2018/5/1/1631b6f52f7e7015?w=344&h=344&f=jpeg&s=8317)
